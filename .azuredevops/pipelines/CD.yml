trigger: none

name: 'Deploy Application'
pool:
  vmImage: 'ubuntu-latest'

variables:
  - name: name
    value: mscnet7dapracasample
  
  - name: location
    value: eastus

stages:
  - stage: ContainerizeApp
    displayName: Containerize .NET Application
    jobs:
      - job: BuildDotNet
        displayName: Build .NET App
        steps:
          - task: UseDotNet@2
            displayName: 'Use .NET'
            inputs:
              version: 7.x
          - task: DotNetCoreCLI@2
            name: Build
            inputs:
              command: 'build'
              projects: ./source
              arguments: '--configuration Release'
  - stage: ProvisionAzure
    displayName: Provision Azure resources
    jobs:
      - job: DeployBicep
        displayName: Deploy Bicep file
        steps:
          - task: AzureCLI@2
            displayName: Azure CLI deployment
            inputs:
              azureSubscription: $(AZURE_SERVICE_CONNECTION)
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                az deployment sub create \
                  --location $(location) \
                  --template-file ./infra/main.bicep \
                  --parameters name=$(name) location=$(location)

